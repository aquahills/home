<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<link rel="stylesheet" href="css/style.css">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{margin:0;overflow-x:hidden}

/* ===== MOBILE HEADER FIX (same style as order.html) ===== */
@media(max-width:768px){


.topbar-row{
flex-direction:column;
align-items:stretch;
gap:15px;
}

/* Keep menu icon aligned left */
.menu-btn{
align-self:flex-start;
margin-left:10px;
}

.nav-buttons{
flex-direction:column;
align-items:center;
width:100%;
}

.nav-buttons button{
width:100%;
max-width:280px;
}

.logo{
height:85px !important;
}

}


/* ===== TABLE SCROLL FIX (same as orders.html) ===== */
.table-wrapper{
width:100%;
overflow-x:auto;
-webkit-overflow-scrolling:touch;
}

table{
min-width:500px;
}

/* ===== MOBILE STACK CONTROLS ===== */
@media(max-width:768px){

.controls{
flex-direction:column;
align-items:center;
}

.controls input,
.controls select{
width:100%;
max-width:300px;
}

.action-group{
flex-direction:column;
align-items:center;
}

}

.topbar{
display:flex;
flex-direction:column;
align-items:center;
padding:20px 20px 10px 20px;
background:transparent;
}

.topbar-row{
width:100%;
display:flex;
justify-content:space-between;
align-items:center;
}

.logo{
height:110px;
margin:10px 0;
}

.admin-title{
font-size:30px;
font-weight:500;
opacity:0.85;
letter-spacing:1px;
}

.nav-buttons{
display:flex;
gap:10px;
}

.nav-buttons button{
padding:8px 18px;
border-radius:25px;
border:1px solid white;
background:transparent;
color:white;
cursor:pointer;
font-weight:600;
transition:.3s;
}

.nav-buttons button:hover{
background:white;
color:#0a5fd8;
}


.menu-btn{font-size:26px;cursor:pointer;margin-right:15px}

.sidebar{
position:fixed;
left:-260px;
top:0;
width:250px;
height:100%;
background:linear-gradient(180deg,#062c5c,#0a5fd8);
padding:30px 20px;
transition:.3s;
z-index:1001
}

.sidebar.active{left:0}

.sidebar button{
width:100%;
padding:12px;
margin-bottom:15px;
border-radius:25px;
border:1px solid rgba(255,255,255,.3);
background:transparent;
color:white;
font-weight:600;
cursor:pointer
}

.sidebar button:hover{background:white;color:#0a5fd8}

.overlay{
position:fixed;
width:100%;
height:100%;
background:rgba(0,0,0,.4);
display:none;
z-index:1000
}

.overlay.active{display:block}

.content{
display:flex;
justify-content:center;
padding:40px 20px
}

.wrapper{
width:100%;
max-width:1100px
}

.admin-card{
background:rgba(255,255,255,.15);
backdrop-filter:blur(15px);
padding:30px;
border-radius:20px;
box-shadow:0 10px 30px rgba(0,0,0,.3);
text-align:center;
}

.dashboard-grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(260px,420px));
justify-content:center;
gap:20px;
}


.stat{
background:rgba(255,255,255,.2);
padding:22px 20px;
border-radius:18px;
text-align:center;
cursor:pointer;
transition:.3s;
max-width:420px;
margin:auto;
}

.stat h2{
font-size:32px;
margin-bottom:8px;
}

.stat p{
font-size:16px;
font-weight:500;
letter-spacing:0.5px;
}


.stat:hover{transform:translateY(-5px)}

.controls{
display:flex;
justify-content:center;
gap:15px;
margin-bottom:20px;
flex-wrap:wrap
}

input,select{
padding:8px 12px;
border-radius:25px;
border:none
}

table{
width:100%;
border-collapse:collapse;
text-align:center
}

th,td{
padding:14px;
border-bottom:1px solid rgba(255,255,255,.2);
text-align:center
}

.action-group{
display:flex;
justify-content:center;
gap:10px
}

.theme-btn{
padding:8px 18px;
border-radius:25px;
border:none;
background:white;
color:#0a5fd8;
font-weight:600;
cursor:pointer;
transition:.3s
}

.theme-btn:hover{transform:scale(1.05)}

.danger-btn{background:#ff4d4d;color:white}
.success-btn{background:#00b4ff;color:white}

.edit-input{
padding:6px;
border-radius:10px;
border:none;
text-align:center;
width:100%
}

.modal{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,.5);
display:none;
align-items:center;
justify-content:center;
z-index:2000
}

.modal-content{
background:#062c5c;
padding:30px;
border-radius:20px;
text-align:center;
width:90%;
max-width:400px
}

.modal-buttons{
display:flex;
justify-content:center;
gap:15px;
margin-top:20px
}
  
/* ===== STRICT MOBILE CONTAINER CONTROL ===== */
@media(max-width:768px){

.content{
padding:20px 10px !important;
}

.wrapper{
width:100% !important;
max-width:100% !important;
}

.admin-card{
width:100% !important;
padding:20px !important;
}

.dashboard-grid{
grid-template-columns:1fr !important;
}

.stat{
width:100% !important;
}
}

</style>
</head>

<body>

<div class="topbar">

<div class="topbar-row">
<div class="menu-btn" onclick="toggleSidebar()">â˜°</div>

<div class="nav-buttons">
<button onclick="window.location.href='index.html'">Home</button>
<button onclick="logout()">Logout</button>
</div>
</div>

<img src="assets/logo.png" class="logo">

<div class="admin-title">Admin Panel</div>

</div>


<div class="sidebar" id="sidebar">
<button onclick="navigate('dashboard')">Dashboard</button>
<button onclick="navigate('ordersSummary')">Orders</button>
<button onclick="navigate('assignOrders')">Assign Orders</button>
<button onclick="navigate('users')">Users</button>
<button onclick="navigate('settings')">Pricing</button>
<button onclick="logout()">Logout</button>
</div>

<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<div class="content">
<div class="wrapper" id="contentArea"></div>
</div>

<div class="modal" id="deleteModal">
<div class="modal-content">
<h3>Delete this user?</h3>
<div class="modal-buttons">
<button class="theme-btn danger-btn" onclick="confirmDelete()">Delete</button>
<button class="theme-btn" onclick="closeModal()">Cancel</button>
</div>
</div>
</div>

<script src="js/firebase.js"></script>

<script>
let deleteUserId=null

function toggleSidebar(){sidebar.classList.toggle("active");overlay.classList.toggle("active")}
function closeSidebar(){sidebar.classList.remove("active");overlay.classList.remove("active")}
function navigate(s){closeSidebar();showSection(s)}

firebase.auth().onAuthStateChanged(async user=>{
if(!user)return location.href="login.html"
const doc=await db.collection("users").doc(user.uid).get()
if(doc.data()?.role!=="admin")return location.href="index.html"
showSection("dashboard")
})

function logout(){firebase.auth().signOut().then(()=>location.href="index.html")}

function showSection(s){
if(s==="dashboard")loadDashboard()
if(s==="users")loadUsers()
if(s==="activeOrders")loadActiveOrders()
if(s==="ordersSummary")loadOrdersSummary()
if(s==="settings")loadSettings()
if(s==="assignOrders")loadAssignOrders()
}

async function loadAssignOrders(){

const ordersSnap=await db.collection("orders")
.where("status","==","Pending")
.get()

const deliverySnap=await db.collection("users")
.where("role","==","delivery")
.get()

let rows=""

for(const doc of ordersSnap.docs){

const o=doc.data()
if(o.assignedTo) continue

rows+=`
<tr>
<td>${doc.id}</td>
<td>${o.bottles}</td>
<td>â‚¹${o.total}</td>
<td>
<select id="agent_${doc.id}">
${deliverySnap.docs.map(u=>`<option value="${u.id}">${u.data().name||u.data().email}</option>`).join("")}
</select>
</td>
<td>
<button class="theme-btn success-btn" onclick="assignOrder('${doc.id}')">
Assign
</button>
</td>
</tr>`
}

contentArea.innerHTML=`
<div class="admin-card">
<h2>Assign Pending Orders</h2>
<div class="table-wrapper">
<table>
<tr>
<th>Order ID</th>
<th>Bottles</th>
<th>Total</th>
<th>Delivery Agent</th>
<th>Action</th>
</tr>
${rows||"<tr><td colspan='5'>No Unassigned Orders</td></tr>"}
</table>
</div>
</div>`
}

async function assignOrder(orderId){
const agent=document.getElementById("agent_"+orderId).value
await db.collection("orders").doc(orderId).update({assignedTo:agent})
loadAssignOrders()
}
/* DASHBOARD */
async function loadDashboard(){
const orders=await db.collection("orders").get()
const users=await db.collection("users").get()
const active=orders.docs.filter(d=>d.data().status!=="Delivered")

contentArea.innerHTML=`
<div class="admin-card">
<div class="dashboard-grid">
<div class="stat" onclick="navigate('users')">
<h2>ðŸ‘¥ ${users.size}</h2>
<p>All Users</p>
</div>
<div class="stat" onclick="navigate('activeOrders')">
<h2>ðŸ“¦ ${active.length}</h2>
<p>Active Orders</p>
</div>
</div>
</div>`
}
/* ORDERS SUMMARY */
async function loadOrdersSummary(){
const orders=await db.collection("orders").get()
const users=await db.collection("users").get()

const map={}
orders.forEach(o=>{
const d=o.data()
if(!map[d.customerId])map[d.customerId]=[]
map[d.customerId].push(d)
})

let rows=""
users.forEach(u=>{
const userOrders=map[u.id]||[]
if(userOrders.length===0)return

const last=userOrders.sort((a,b)=>{
if(!a.createdAt||!b.createdAt)return 0
return b.createdAt.seconds-a.createdAt.seconds
})[0]

rows+=`
<tr>
<td>${u.data().name||""}</td>
<td>${userOrders.length}</td>
<td>${last?.createdAt?.toDate().toLocaleDateString()||""}</td>
<td>
<button class="theme-btn" onclick="showUserOrders('${u.id}')">
Show All Orders
</button>
</td>
</tr>`
})

contentArea.innerHTML=`
<div class="admin-card">
<h2>Orders Summary</h2>
<div class="table-wrapper">
<table>
<tr>
<th>Name</th>
<th>Orders Placed</th>
<th>Last Order</th>
<th>Action</th>
</tr>
${rows}
</table>
</div>
</div>`
}

  async function showUserOrders(id){
const snap=await db.collection("orders").where("customerId","==",id).get()

let rows=""
snap.forEach(doc=>{
const o=doc.data()

let formattedDate=""
if(o.createdAt){
formattedDate = o.createdAt.toDate().toLocaleString("en-IN", {
timeZone: "Asia/Kolkata",
year: "numeric",
month: "short",
day: "numeric",
hour: "2-digit",
minute: "2-digit"
})
}

rows+=`
<tr>
<td>${o.bottles}</td>
<td>â‚¹${o.total}</td>
<td>${formattedDate}</td>
<td>${o.status}</td>
</tr>`
})


contentArea.innerHTML=`
<div class="admin-card">
<h2>User Orders</h2>
<div class="table-wrapper">
<table>
<tr>
<th>Bottles</th>
<th>Total</th>
<th>Date & Time (IST)</th>
<th>Status</th>
</tr>
${rows}
</table>
<div style="margin-top:20px;text-align:center;">
<button class="theme-btn" onclick="navigate('ordersSummary')">
Back
</button>
</div>
</div>
</div>`
}

/* USERS WITH INLINE EDIT */
async function loadUsers(){
const snap=await db.collection("users").get()

let rows=""
snap.forEach(doc=>{
const u=doc.data()
rows+=`
<tr data-id="${doc.id}">
<td>${u.name||""}</td>
<td>${u.phone||""}</td>
<td>${u.email||""}</td>
<td>${u.role}</td>
<td>
<div class="action-group">
<button class="theme-btn" onclick="enableEdit('${doc.id}')">Edit</button>
<button class="theme-btn danger-btn" onclick="openDelete('${doc.id}')">Delete</button>
</div>
</td>
</tr>`
})

contentArea.innerHTML=`
<div class="admin-card">
<h2>All Users</h2>

<div class="controls">
<input type="text" id="searchInput" placeholder="Search..." onkeyup="searchUsers()">
<select id="roleFilter" onchange="filterUsers()">
<option value="">All Roles</option>
<option value="admin">Admin</option>
<option value="customer">Customer</option>
<option value="delivery">Delivery</option>
</select>
</div>

<div class="table-wrapper">
<table id="usersTable">
<tr>
<th>Name</th>
<th>Phone</th>
<th>Email</th>
<th>Role</th>
<th>Action</th>
</tr>
${rows}
</table>
</div>
</div>`
}

function searchUsers(){
const val=document.getElementById("searchInput").value.toLowerCase()
document.querySelectorAll("#usersTable tr").forEach((row,i)=>{
if(i===0)return
row.style.display=row.innerText.toLowerCase().includes(val)?"":"none"
})
}

function filterUsers(){
const value=document.getElementById("roleFilter").value
document.querySelectorAll("#usersTable tr").forEach((row,i)=>{
if(i===0)return
row.style.display=value===""||row.children[3].innerText===value?"":"none"
})
}

function enableEdit(id){
const row=document.querySelector(`tr[data-id='${id}']`)
const cells=row.children
const name=cells[0].innerText
const phone=cells[1].innerText
const email=cells[2].innerText
const role=cells[3].innerText

row.innerHTML=`
<td><input class="edit-input" id="name_${id}" value="${name}"></td>
<td><input class="edit-input" id="phone_${id}" value="${phone}"></td>
<td><input class="edit-input" id="email_${id}" value="${email}"></td>
<td>
<select id="role_${id}" class="edit-input">
<option ${role==="admin"?"selected":""}>admin</option>
<option ${role==="customer"?"selected":""}>customer</option>
<option ${role==="delivery"?"selected":""}>delivery</option>
</select>
</td>
<td>
<div class="action-group">
<button class="theme-btn success-btn" onclick="saveUser('${id}')">Save</button>
<button class="theme-btn" onclick="loadUsers()">Cancel</button>
</div>
</td>`
}

async function saveUser(id){
await db.collection("users").doc(id).update({
name:document.getElementById(`name_${id}`).value,
phone:document.getElementById(`phone_${id}`).value,
email:document.getElementById(`email_${id}`).value,
role:document.getElementById(`role_${id}`).value
})
loadUsers()
}

function openDelete(id){
deleteUserId=id
document.getElementById("deleteModal").style.display="flex"
}

function closeModal(){
document.getElementById("deleteModal").style.display="none"
deleteUserId=null
}

async function confirmDelete(){
if(deleteUserId === firebase.auth().currentUser.uid){
alert("You cannot delete yourself.");
return;
}
await db.collection("users").doc(deleteUserId).delete()
closeModal()
loadUsers()
}

/* ACTIVE ORDERS (unchanged logic) */
/* ACTIVE ORDERS */
async function loadActiveOrders(){

const snap = await db.collection("orders")
.where("status","in",["Pending","Assigned"])
.get()

let rows=""

for(const doc of snap.docs){

const o = doc.data()

const uDoc = await db.collection("users").doc(o.customerId).get()
const u = uDoc.data() || {}

// Get Assigned Delivery Agent
let assignedName = "Not Assigned"

if(o.assignedTo){
  const agentDoc = await db.collection("users").doc(o.assignedTo).get()
  const agentData = agentDoc.data()
  assignedName = agentData?.name || agentData?.email || "Assigned"
}

rows += `
<tr>
<td>${u.name||""}</td>
<td>${u.phone||""}</td>
<td>${o.bottles}</td>
<td>â‚¹${o.total}</td>
<td>${assignedName}</td>
<td>
<button class="theme-btn success-btn" onclick="markDelivered('${doc.id}')">
Mark Delivered
</button>
</td>
</tr>`
}

contentArea.innerHTML = `
<div class="admin-card">
<h2>Active Orders</h2>
<div class="table-wrapper">
<table>
<tr>
<th>Name</th>
<th>Phone</th>
<th>Bottles</th>
<th>Total</th>
<th>Assigned To</th>
<th>Action</th>
</tr>
${rows}
</table>
</div>
</div>`
}


async function markDelivered(id){
await db.collection("orders").doc(id).update({status:"Delivered"})
loadActiveOrders()
}

/* SETTINGS unchanged */
async function loadSettings(){
const doc=await db.collection("settings").doc("global").get()
const price=doc.data()?.price||75

contentArea.innerHTML=`
<div class="admin-card">
<h2>Bottle Pricing</h2>
<div style="display:flex;gap:15px;margin-top:20px;justify-content:center;align-items:center;">
<input type="number" id="priceInput" value="${price}" style="width:200px;">
<button class="theme-btn" onclick="savePrice()">Save</button>
</div>
</div>`
}

async function savePrice(){

await db.collection("settings").doc("global").update({
price:Number(priceInput.value)
})

const card = document.querySelector(".admin-card")

const msg = document.createElement("div")
msg.style.marginTop="20px"
msg.style.opacity="0.9"
msg.innerText="Price updated successfully."

card.appendChild(msg)

setTimeout(()=>{
msg.remove()
},2500)

}

</script>

</body>
</html>
