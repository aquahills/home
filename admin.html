<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>
<link rel="stylesheet" href="css/style.css">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{margin:0;overflow-x:hidden}

.topbar{
height:70px;
display:flex;
align-items:center;
padding:0 25px;
background:rgba(0,0,0,.3)
}

.menu-btn{font-size:26px;cursor:pointer;margin-right:15px}

.sidebar{
position:fixed;
left:-260px;
top:0;
width:250px;
height:100%;
background:linear-gradient(180deg,#062c5c,#0a5fd8);
padding:30px 20px;
transition:.3s;
z-index:1001
}

.sidebar.active{left:0}

.sidebar button{
width:100%;
padding:12px;
margin-bottom:15px;
border-radius:25px;
border:1px solid rgba(255,255,255,.3);
background:transparent;
color:white;
font-weight:600;
cursor:pointer
}

.sidebar button:hover{background:white;color:#0a5fd8}

.overlay{
position:fixed;
width:100%;
height:100%;
background:rgba(0,0,0,.4);
display:none;
z-index:1000
}

.overlay.active{display:block}

.content{
display:flex;
justify-content:center;
padding:40px 20px
}

.wrapper{
width:100%;
max-width:1200px
}

.admin-card{
background:rgba(255,255,255,.15);
backdrop-filter:blur(15px);
padding:30px;
border-radius:20px;
box-shadow:0 10px 30px rgba(0,0,0,.3)
}

h2{text-align:center;margin-bottom:25px}

.controls{
display:flex;
justify-content:center;
gap:15px;
margin-bottom:20px;
flex-wrap:wrap
}

input,select{
padding:8px 12px;
border-radius:25px;
border:none
}

table{
width:100%;
border-collapse:collapse;
text-align:center
}

th,td{
padding:12px;
border-bottom:1px solid rgba(255,255,255,.2);
text-align:center
}

.action-group{
display:flex;
justify-content:center;
gap:8px
}

.theme-btn{
padding:6px 14px;
border-radius:25px;
border:none;
background:white;
color:#0a5fd8;
font-weight:600;
cursor:pointer
}

.danger-btn{background:#ff4d4d;color:white}
.success-btn{background:#00b4ff;color:white}

.edit-input{
width:100%;
border-radius:10px;
border:none;
padding:6px;
text-align:center
}

.modal{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,.5);
display:flex;
align-items:center;
justify-content:center;
z-index:2000;
display:none
}

.modal-content{
background:#062c5c;
padding:30px;
border-radius:20px;
text-align:center;
width:90%;
max-width:400px
}

.modal-buttons{
display:flex;
justify-content:center;
gap:15px;
margin-top:20px
}
</style>
</head>

<body>

<div class="topbar">
<div class="menu-btn" onclick="toggleSidebar()">â˜°</div>
<h3>Admin Panel</h3>
</div>

<div class="sidebar" id="sidebar">
<button onclick="navigate('dashboard')">Dashboard</button>
<button onclick="navigate('users')">Users</button>
<button onclick="navigate('settings')">Settings</button>
<button onclick="logout()">Logout</button>
</div>

<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<div class="content">
<div class="wrapper" id="contentArea"></div>
</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
  <div class="modal-content">
    <h3>Delete this user?</h3>
    <div class="modal-buttons">
      <button class="theme-btn danger-btn" onclick="confirmDelete()">Delete</button>
      <button class="theme-btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script src="js/firebase.js"></script>

<script>
let deleteUserId=null

function toggleSidebar(){sidebar.classList.toggle("active");overlay.classList.toggle("active")}
function closeSidebar(){sidebar.classList.remove("active");overlay.classList.remove("active")}
function navigate(s){closeSidebar();if(s==="users")loadUsers();if(s==="settings")loadSettings();if(s==="dashboard")loadDashboard()}

firebase.auth().onAuthStateChanged(async user=>{
if(!user)return location.href="login.html"
const doc=await db.collection("users").doc(user.uid).get()
if(doc.data()?.role!=="admin")return location.href="index.html"
loadDashboard()
})

function logout(){firebase.auth().signOut().then(()=>location.href="index.html")}

async function loadDashboard(){
const users=await db.collection("users").get()
contentArea.innerHTML=`
<div class="admin-card">
<h2>Dashboard</h2>
<p>Total Users: ${users.size}</p>
</div>`
}

/* USERS */
async function loadUsers(){
const snap=await db.collection("users").get()

let rows=""
snap.forEach(doc=>{
const u=doc.data()
rows+=`
<tr data-id="${doc.id}">
<td>${u.name||""}</td>
<td>${u.phone||""}</td>
<td>${u.email||""}</td>
<td>${u.role}</td>
<td>
<div class="action-group">
<button class="theme-btn" onclick="enableEdit('${doc.id}')">Edit</button>
<button class="theme-btn danger-btn" onclick="openDelete('${doc.id}')">Delete</button>
</div>
</td>
</tr>`
})

contentArea.innerHTML=`
<div class="admin-card">
<h2>All Users</h2>

<div class="controls">
<input type="text" id="searchInput" placeholder="Search..." onkeyup="searchUsers()">
<select id="roleFilter" onchange="filterUsers()">
<option value="">All Roles</option>
<option value="admin">Admin</option>
<option value="customer">Customer</option>
<option value="delivery">Delivery</option>
</select>
</div>

<table id="usersTable">
<tr>
<th>Name</th>
<th>Phone</th>
<th>Email</th>
<th>Role</th>
<th>Action</th>
</tr>
${rows}
</table>
</div>`
}

function searchUsers(){
const val=document.getElementById("searchInput").value.toLowerCase()
document.querySelectorAll("#usersTable tr").forEach((row,i)=>{
if(i===0)return
row.style.display=row.innerText.toLowerCase().includes(val)?"":"none"
})
}

function filterUsers(){
const role=document.getElementById("roleFilter").value
document.querySelectorAll("#usersTable tr").forEach((row,i)=>{
if(i===0)return
const r=row.children[3].innerText
row.style.display=(role===""||r===role)?"":"none"
})
}

function enableEdit(id){
const row=document.querySelector(`tr[data-id='${id}']`)
const cells=row.children
const name=cells[0].innerText
const phone=cells[1].innerText
const email=cells[2].innerText
const role=cells[3].innerText

row.innerHTML=`
<td><input class="edit-input" value="${name}" id="name_${id}"></td>
<td><input class="edit-input" value="${phone}" id="phone_${id}"></td>
<td><input class="edit-input" value="${email}" id="email_${id}"></td>
<td>
<select id="role_${id}" class="edit-input">
<option ${role==="admin"?"selected":""}>admin</option>
<option ${role==="customer"?"selected":""}>customer</option>
<option ${role==="delivery"?"selected":""}>delivery</option>
</select>
</td>
<td>
<div class="action-group">
<button class="theme-btn success-btn" onclick="saveUser('${id}')">Save</button>
<button class="theme-btn" onclick="loadUsers()">Cancel</button>
</div>
</td>`
}

async function saveUser(id){
await db.collection("users").doc(id).update({
name:document.getElementById(`name_${id}`).value,
phone:document.getElementById(`phone_${id}`).value,
email:document.getElementById(`email_${id}`).value,
role:document.getElementById(`role_${id}`).value
})
loadUsers()
}

/* DELETE */
function openDelete(id){
deleteUserId=id
document.getElementById("deleteModal").style.display="flex"
}

function closeModal(){
document.getElementById("deleteModal").style.display="none"
deleteUserId=null
}

async function confirmDelete(){
if(!deleteUserId)return
await db.collection("users").doc(deleteUserId).delete()
closeModal()
loadUsers()
}

/* SETTINGS */
async function loadSettings(){
const doc=await db.collection("settings").doc("global").get()
const price=doc.data()?.price||75
contentArea.innerHTML=`
<div class="admin-card">
<h2>Settings</h2>
<input type="number" id="priceInput" value="${price}">
<button class="theme-btn" onclick="savePrice()">Save</button>
</div>`
}

async function savePrice(){
await db.collection("settings").doc("global").update({price:Number(priceInput.value)})
alert("Updated")
}
</script>

</body>
</html>
