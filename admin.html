<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>
<link rel="stylesheet" href="css/style.css">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{margin:0;overflow-x:hidden}

.topbar{
height:70px;
display:flex;
align-items:center;
padding:0 25px;
background:rgba(0,0,0,.3)
}

.menu-btn{font-size:26px;cursor:pointer;margin-right:15px}

.sidebar{
position:fixed;
left:-260px;
top:0;
width:250px;
height:100%;
background:linear-gradient(180deg,#062c5c,#0a5fd8);
padding:30px 20px;
transition:.3s;
z-index:1001
}

.sidebar.active{left:0}

.sidebar button{
width:100%;
padding:12px;
margin-bottom:15px;
border-radius:25px;
border:1px solid rgba(255,255,255,.3);
background:transparent;
color:white;
font-weight:600;
cursor:pointer
}

.sidebar button:hover{background:white;color:#0a5fd8}

.overlay{
position:fixed;
width:100%;
height:100%;
background:rgba(0,0,0,.4);
display:none;
z-index:1000
}

.overlay.active{display:block}

.content{
display:flex;
justify-content:center;
padding:40px 20px
}

.wrapper{
width:100%;
max-width:1100px
}

.admin-card{
background:rgba(255,255,255,.15);
backdrop-filter:blur(15px);
padding:30px;
border-radius:20px;
box-shadow:0 10px 30px rgba(0,0,0,.3)
}

h2{text-align:center;margin-bottom:25px}

.dashboard-grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
gap:25px
}

.stat{
background:rgba(255,255,255,.2);
padding:35px;
border-radius:18px;
text-align:center;
cursor:pointer;
transition:.3s
}

.stat:hover{transform:translateY(-5px)}

.stat h2{margin:0;font-size:34px}

.controls{
display:flex;
justify-content:center;
gap:15px;
margin-bottom:20px;
flex-wrap:wrap
}

input,select{
padding:8px 12px;
border-radius:25px;
border:none
}

table{
width:100%;
border-collapse:collapse;
text-align:center
}

th,td{
padding:14px;
border-bottom:1px solid rgba(255,255,255,.2);
text-align:center
}

.action-group{
display:flex;
justify-content:center;
gap:10px
}

.theme-btn{
padding:8px 18px;
border-radius:25px;
border:none;
background:white;
color:#0a5fd8;
font-weight:600;
cursor:pointer;
transition:.3s
}

.theme-btn:hover{transform:scale(1.05)}

.danger-btn{
background:#ff4d4d;
color:white
}

.success-btn{
background:#00b4ff;
color:white
}

.center-btn{
display:flex;
justify-content:center;
margin-top:25px
}

@media(max-width:768px){
.content{padding:20px 15px}
}
</style>
</head>

<body>

<div class="topbar">
<div class="menu-btn" onclick="toggleSidebar()">â˜°</div>
<h3>Admin Panel</h3>
</div>

<div class="sidebar" id="sidebar">
<button onclick="navigate('dashboard')">Dashboard</button>
<button onclick="navigate('ordersSummary')">Orders</button>
<button onclick="navigate('users')">Users</button>
<button onclick="navigate('settings')">Settings</button>
<button onclick="logout()">Logout</button>
</div>

<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<div class="content">
<div class="wrapper" id="contentArea"></div>
</div>

<script src="js/firebase.js"></script>

<script>
function toggleSidebar(){sidebar.classList.toggle("active");overlay.classList.toggle("active")}
function closeSidebar(){sidebar.classList.remove("active");overlay.classList.remove("active")}
function navigate(s){closeSidebar();showSection(s)}

firebase.auth().onAuthStateChanged(async user=>{
if(!user)return location.href="login.html"
const doc=await db.collection("users").doc(user.uid).get()
if(doc.data()?.role!=="admin")return location.href="index.html"
showSection("dashboard")
})

function logout(){firebase.auth().signOut().then(()=>location.href="index.html")}

function showSection(s){
if(s==="dashboard")loadDashboard()
if(s==="users")loadUsers()
if(s==="activeOrders")loadActiveOrders()
if(s==="ordersSummary")loadOrdersSummary()
if(s==="settings")loadSettings()
}

/* DASHBOARD */
async function loadDashboard(){
const orders=await db.collection("orders").get()
const users=await db.collection("users").get()
const active=orders.docs.filter(d=>d.data().status!=="Delivered")

contentArea.innerHTML=`
<div class="admin-card">
<div class="dashboard-grid">
<div class="stat" onclick="navigate('users')">
<h2>ðŸ‘¥ ${users.size}</h2>
<p>All Users</p>
</div>
<div class="stat" onclick="navigate('activeOrders')">
<h2>ðŸ“¦ ${active.length}</h2>
<p>Active Orders</p>
</div>
</div>
</div>`
}

/* USERS */
async function loadUsers(){
const snap=await db.collection("users").get()

let rows=""
snap.forEach(doc=>{
const u=doc.data()
rows+=`
<tr>
<td>${u.name||""}</td>
<td>${u.phone||""}</td>
<td>${u.role}</td>
<td>
<div class="action-group">
<button class="theme-btn" onclick="editUser('${doc.id}')">Edit</button>
<button class="theme-btn danger-btn" onclick="deleteUser('${doc.id}')">Delete</button>
</div>
</td>
</tr>`
})

contentArea.innerHTML=`
<div class="admin-card">
<h2>All Users</h2>

<div class="controls">
<select id="roleFilter" onchange="filterUsers()">
<option value="">All Roles</option>
<option value="admin">Admin</option>
<option value="customer">Customer</option>
<option value="delivery">Delivery</option>
</select>
</div>

<table id="usersTable">
<tr>
<th>Name</th>
<th>Phone</th>
<th>Role</th>
<th>Action</th>
</tr>
${rows}
</table>
</div>`
}

function filterUsers(){
const value=document.getElementById("roleFilter").value
const rows=document.querySelectorAll("#usersTable tr")
rows.forEach((row,i)=>{
if(i===0)return
const role=row.children[2].innerText
row.style.display=value===""||role===value?"":"none"
})
}

function editUser(id){
const role=prompt("Enter role: admin / customer / delivery")
if(!role)return
db.collection("users").doc(id).update({role})
loadUsers()
}

function deleteUser(id){
if(confirm("Delete user?")){
db.collection("users").doc(id).delete()
loadUsers()
}
}

/* ACTIVE ORDERS */
async function loadActiveOrders(){
const snap=await db.collection("orders").where("status","!=","Delivered").get()

let rows=""
for(const doc of snap.docs){
const o=doc.data()
const uDoc=await db.collection("users").doc(o.customerId).get()
const u=uDoc.data()||{}
rows+=`
<tr>
<td>${u.name||""}</td>
<td>${u.phone||""}</td>
<td>${o.bottles}</td>
<td>â‚¹${o.total}</td>
<td>
<button class="theme-btn success-btn" onclick="markDelivered('${doc.id}')">Mark Delivered</button>
</td>
</tr>`
}

contentArea.innerHTML=`
<div class="admin-card">
<h2>Active Orders</h2>
<table>
<tr>
<th>Name</th>
<th>Phone</th>
<th>Bottles</th>
<th>Total</th>
<th>Action</th>
</tr>
${rows}
</table>
</div>`
}

async function markDelivered(id){
await db.collection("orders").doc(id).update({status:"Delivered"})
loadActiveOrders()
}

/* ORDERS SUMMARY */
async function loadOrdersSummary(){
const orders=await db.collection("orders").get()
const users=await db.collection("users").get()

const map={}
orders.forEach(o=>{
const d=o.data()
if(!map[d.customerId])map[d.customerId]=[]
map[d.customerId].push(d)
})

let rows=""
users.forEach(u=>{
const userOrders=map[u.id]||[]
if(userOrders.length===0)return
const last=userOrders.sort((a,b)=>b.createdAt?.seconds-a.createdAt?.seconds)[0]
rows+=`
<tr>
<td>${u.data().name||""}</td>
<td>${userOrders.length}</td>
<td>${last?.createdAt?.toDate().toLocaleDateString()||""}</td>
<td>
<button class="theme-btn" onclick="showUserOrders('${u.id}')">Show All Orders</button>
</td>
</tr>`
})

contentArea.innerHTML=`
<div class="admin-card">
<h2>Orders Summary</h2>
<table>
<tr>
<th>Name</th>
<th>Orders Placed</th>
<th>Last Order</th>
<th>Action</th>
</tr>
${rows}
</table>
</div>`
}

async function showUserOrders(id){
const snap=await db.collection("orders").where("customerId","==",id).get()
let rows=""
snap.forEach(doc=>{
const o=doc.data()
rows+=`
<tr>
<td>${o.bottles}</td>
<td>â‚¹${o.total}</td>
<td>${o.status}</td>
</tr>`
})
contentArea.innerHTML=`
<div class="admin-card">
<h2>User Orders</h2>
<table>
<tr>
<th>Bottles</th>
<th>Total</th>
<th>Status</th>
</tr>
${rows}
</table>
<div class="center-btn">
<button class="theme-btn" onclick="navigate('ordersSummary')">Back</button>
</div>
</div>`
}

/* SETTINGS */
async function loadSettings(){
const doc=await db.collection("settings").doc("global").get()
const price=doc.data()?.price||75

contentArea.innerHTML=`
<div class="admin-card">
<h2>Settings</h2>
<div class="controls">
<input type="number" id="priceInput" value="${price}">
<button class="theme-btn" onclick="savePrice()">Save</button>
</div>
</div>`
}

async function savePrice(){
await db.collection("settings").doc("global").update({price:Number(priceInput.value)})
alert("Updated")
}
</script>

</body>
</html>
