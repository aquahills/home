<!DOCTYPE html>
<html>
<head>
  <title>Place Order</title>
  <link rel="stylesheet" href="css/style.css">

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body>

<header>
  <img src="assets/logo.png" class="logo" />
  <nav>
    <button onclick="window.location.href='orders.html'">My Orders</button>
    <button onclick="window.location.href='index.html'">Home</button>
  </nav>
</header>

<main class="center">

  <div class="card">
    <h2>Place Your Order</h2>

    <div style="margin:20px 0;">
      <button onclick="changeQty(-1)">-</button>
      <input id="qty" type="number" value="1" min="1" style="width:60px; text-align:center;">
      <button onclick="changeQty(1)">+</button>
    </div>

    <p><strong>Total: ₹<span id="total">0</span></strong></p>

    <button class="primary-btn" onclick="confirmOrder()">Confirm Order</button>
  </div>

</main>

<footer class="footer">
  <div class="footer-container">
    <div>
      <h3>Aquahills Beverages</h3>
      <p>Pure & Safe Drinking Water</p>
    </div>
    <div>
      <h4>Contact</h4>
      <p>Phone: +91 9876543210</p>
      <p>Email: support@aquahills.com</p>
    </div>
    <div>
      <h4>Location</h4>
      <p>Ghaziabad, Uttar Pradesh</p>
    </div>
  </div>
  <p class="footer-bottom">© 2026 Aquahills Beverages</p>
</footer>

<script src="js/firebase.js"></script>

<script>
let currentPrice = 75;

document.addEventListener("DOMContentLoaded", () => {

  firebase.auth().onAuthStateChanged(async (user) => {

    if (!user) {
      window.location.href = "login.html";
      return;
    }

    const settingsDoc = await db.collection("settings").doc("global").get();
    if (settingsDoc.exists) {
      currentPrice = settingsDoc.data().price || 75;
    }

    updateTotal();

  });

});

function changeQty(change) {
  const qtyInput = document.getElementById("qty");
  let qty = Number(qtyInput.value || 1);
  qty += change;
  if (qty < 1) qty = 1;
  qtyInput.value = qty;
  updateTotal();
}

function updateTotal() {
  const qty = Number(document.getElementById("qty").value || 1);
  document.getElementById("total").innerText = qty * currentPrice;
}

async function confirmOrder() {

  const user = firebase.auth().currentUser;
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  const qty = Number(document.getElementById("qty").value);

  const userDoc = await db.collection("users").doc(user.uid).get();
  const userData = userDoc.data();

  // Profile validation
  if (!userData.phone ||
      !userData.address.house ||
      !userData.address.city ||
      !userData.address.pincode) {

    alert("Almost done. Please complete your delivery details so we can process your order.");
    window.location.href = "address.html";
    return;
  }

  const settingsRef = db.collection("settings").doc("global");
  const settingsDoc = await settingsRef.get();
  const settings = settingsDoc.data();

  let assignedTo = null;

  if (settings.autoAssign && settings.deliveryAgents.length > 0) {

    const index = settings.lastAssignedIndex || 0;
    assignedTo = settings.deliveryAgents[index];

    const nextIndex = (index + 1) % settings.deliveryAgents.length;

    await settingsRef.update({
      lastAssignedIndex: nextIndex
    });
  }

  await db.collection("orders").add({
    customerId: user.uid,
    customerEmail: user.email,
    bottles: qty,
    total: qty * settings.price,
    status: "Pending",
    assignedTo: assignedTo,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Order placed successfully.");
  window.location.href = "orders.html";
}
</script>

</body>
</html>
