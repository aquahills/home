<!DOCTYPE html>
<html>
<head>
  <title>Place Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">

  <!-- Font Awesome (same as index) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    .order-card{
      width:100%;
      max-width:420px;
      text-align:center;
    }

    .qty-controls{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:15px;
      margin:20px 0;
      flex-wrap:wrap;
    }

    .qty-controls button{
      padding:10px 18px;
      border-radius:25px;
      border:none;
      font-size:18px;
      cursor:pointer;
    }

    /* ===== MATCH INDEX HEADER EXACTLY ===== */

/* Force large logo like index */
.logo{
  height:115px !important;
}

/* On mobile match index logo size */
@media(max-width:768px){
  .logo{
    height:85px !important;
  }
}

/* ===== FIX FOOTER SCATTER ON DESKTOP ===== */



/* Keep mobile stacking same as index */


    .qty-controls input{
      width:70px;
      text-align:center;
      padding:8px;
      border-radius:10px;
      border:none;
    }

    /* MOBILE ONLY HEADER FIX */
    @media(max-width:768px){

      header{
        flex-direction:column;
        align-items:center;
        text-align:center;
        gap:15px;
      }

      nav{
        flex-direction:column;
        align-items:center;
        width:100%;
      }

      nav button{
        width:100%;
        max-width:280px;
      }
    }
  </style>
</head>

<body>

<!-- SAME HEADER STRUCTURE AS INDEX -->
<header>
  <img src="assets/logo.png" class="logo" />

  <nav>
    <button onclick="window.location.href='orders.html'">My Orders</button>
    <button onclick="window.location.href='index.html'">Home</button>
  </nav>
</header>

<main class="center">

  <div class="card order-card">
    <h2>Place Your Order</h2>

    <div class="qty-controls">
      <button onclick="changeQty(-1)">-</button>
      <input id="qty" type="number" value="1" min="1">
      <button onclick="changeQty(1)">+</button>
    </div>

    <p style="font-size:18px;">
      <strong>Total: ₹<span id="total">0</span></strong>
    </p>

    <button class="primary-btn" style="margin-top:20px;" onclick="confirmOrder()">
      Confirm Order
    </button>
  </div>

</main>

<!-- EXACT SAME FOOTER AS INDEX -->
<footer class="footer">
  <div class="footer-container">

    <div class="footer-brand">
      <h3>Aquahills Beverages</h3>
      <p class="tagline">Pure & Safe Drinking Water</p>

      <div class="social-icons">
        <i class="fab fa-facebook-f"></i>
        <i class="fab fa-instagram"></i>
        <i class="fab fa-youtube"></i>
        <i class="fab fa-linkedin-in"></i>
      </div>
    </div>

    <div class="footer-contact">
      <h4>Contact Us</h4>

      <p>
        <i class="fa-solid fa-phone"></i>
        <a href="tel:+919910657711">+91-9910657711</a>
      </p>
    <p>
<i class="fa-solid fa-phone"></i>
<a href="tel:+919911657711">+91-9911657711</a>
</p> 
      <p>
        <i class="fa-solid fa-envelope"></i>
        <a href="mailto:aquahillsbeverages@gmail.com">
          support@aquahills.com
        </a>
      </p>
    </div>

  </div>

  <p class="footer-bottom">
    © 2026 Aquahills Beverages | ISI & BIS Certified | All Rights Reserved
  </p>
</footer>

<script src="js/firebase.js"></script>

<script>
let currentPrice = 75;

document.addEventListener("DOMContentLoaded", () => {

  firebase.auth().onAuthStateChanged(async (user) => {

    if (!user) {
      window.location.href = "login.html";
      return;
    }

    const settingsDoc = await db.collection("settings").doc("global").get();
    const settings = settingsDoc.data() || {};
    currentPrice = settings.price || 75;

    updateTotal();
  });

});

function changeQty(change) {
  const qtyInput = document.getElementById("qty");
  let qty = Number(qtyInput.value || 1);
  qty += change;
  if (qty < 1) qty = 1;
  qtyInput.value = qty;
  updateTotal();
}

function updateTotal() {
  const qty = Number(document.getElementById("qty").value || 1);
  document.getElementById("total").innerText = qty * currentPrice;
}

async function confirmOrder() {

  const user = firebase.auth().currentUser;
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  const qty = Number(document.getElementById("qty").value);

  const userDoc = await db.collection("users").doc(user.uid).get();
  const userData = userDoc.data() || {};
  const address = userData.address || {};
  const isGuest = userData.guest === true;

  // Phone is required for everyone
if (!userData.phone) {
  window.location.href = "address.html?incomplete=true";
  return;
}

// Address required only for non-guest users
if (!isGuest && (
    !address.house ||
    !address.city ||
    !address.pincode
)) {
  window.location.href = "address.html?incomplete=true";
  return;
}

  const settingsDoc = await db.collection("settings").doc("global").get();
  const settings = settingsDoc.data() || {};

  const price = settings.price || 75;
  const autoAssign = settings.autoAssign;
  const agents = settings.deliveryAgents || [];

  let assignedTo = null;

  if (autoAssign && agents.length > 0) {
    const randomIndex = Math.floor(Math.random() * agents.length);
    assignedTo = agents[randomIndex];
  }

  await db.collection("orders").add({
    customerId: user.uid,
    customerEmail: user.email,
    bottles: qty,
    total: qty * price,
    status: "Pending",
    assignedTo: assignedTo,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.querySelector(".order-card").innerHTML = `
    <h2 style="margin-bottom:15px;">Order Placed Successfully</h2>
    <p style="margin-bottom:20px; opacity:0.8;">
      Your order has been received and is being processed.
    </p>
    <button class="primary-btn" onclick="window.location.href='orders.html'">
      Track Order
    </button>
  `;
}
</script>

</body>
</html>
